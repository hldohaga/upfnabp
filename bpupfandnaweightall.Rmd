---
title: "bp upf and na"
output:
  word_document: 
    toc: yes
    fig_caption: yes
    keep_md: yes
  html_document:
    toc: yes
    fig_caption: yes
    number_sections: yes
    keep_md: yes
  pdf_document:
    toc: yes
---

 
# BP and UPF and Na in NDNS Dissertation calculation and results

```{r include=FALSE}
library(haven)
library(data.table)
library(readxl)
library(sensemakr)
library(labelled)
library(survey)
```


```{r read data, message=FALSE, warning=FALSE, include=FALSE}

sav4 <- "/media/david/Elements1/contents/DOHmed/MPH/MPHModules/dissertation/alternativequant/upfnabp/data/UKDA-6533-spss/spss/spss25/ndns_rp_yr1-4a_personleveldietarydata_uk_v2.sav"

sav4b <- "/media/david/Elements1/contents/DOHmed/MPH/MPHModules/dissertation/alternativequant/upfnabp/data/UKDA-6533-spss/spss/spss25/ndns_rp_yr1-4a_indiv_uk.sav"

sav6 <-"/media/david/Elements1/contents/DOHmed/MPH/MPHModules/dissertation/alternativequant/upfnabp/data/UKDA-6533-spss/spss/spss25/ndns_rp_yr5-6a_personleveldietarydata_v2.sav"

sav6b <- "/media/david/Elements1/contents/DOHmed/MPH/MPHModules/dissertation/alternativequant/upfnabp/data/UKDA-6533-spss/spss/spss25/ndns_rp_yr5-6a_indiv.sav"

sav8 <-"/media/david/Elements1/contents/DOHmed/MPH/MPHModules/dissertation/alternativequant/upfnabp/data/UKDA-6533-spss/spss/spss25/ndns_rp_yr7-8a_personleveldietarydata.sav"

sav8b <- "/media/david/Elements1/contents/DOHmed/MPH/MPHModules/dissertation/alternativequant/upfnabp/data/UKDA-6533-spss/spss/spss25/ndns_rp_yr7-8a_indiv.sav"



sav11 <- "/media/david/Elements1/contents/DOHmed/MPH/MPHModules/dissertation/alternativequant/upfnabp/data/UKDA-6533-spss/spss/spss25/ndns_rp_yr9-11a_personleveldietarydata_uk_20210831.sav"

sav11b <- "/media/david/Elements1/contents/DOHmed/MPH/MPHModules/dissertation/alternativequant/upfnabp/data/UKDA-6533-spss/spss/spss25/ndns_rp_yr9-11a_indiv_20211020.sav"

sav4r <- as.data.table(read_sav(sav4))
sav4br <-as.data.table(read_sav(sav4b))

sav6r <- as.data.table(read_sav(sav6))
sav6br <-as.data.table(read_sav(sav6b))

sav8r <- as.data.table(read_sav(sav8))
sav8br <-as.data.table(read_sav(sav8b))


sav11r <- as.data.table(read_sav(sav11))
sav11br <- as.data.table(read_sav(sav11b))
sav11br$area <- sav11br$Area
```


```{r std names4, message=FALSE, warning=FALSE, include=FALSE}
#standardise the variable names for grp 1-4 
sav4br$bpmedc2 <- sav4br$bpmedc
sav4br$bpmedd2 <- sav4br$bpmedd
sav4br$diur2 <- sav4br$diur
sav4br$beta2 <- sav4br$beta
sav4br$aceinh2 <- sav4br$aceinh
sav4br$calciumb2 <- sav4br$calciumb
sav4br$obpdrug2 <- sav4br$obpdrug

sav4br$ethgrp5 <- sav4br$ethgr5
sav4br$ethgrp2 <- sav4br$ethgr2

sav4br$hyper140_2 <- sav4br$hyper140
sav4br$hibp140_2 <- sav4br$hibp140
sav4br$hyper1_2 <- sav4br$hyper1
sav4br$highbp1_2 <- sav4br$highbp1

sav4br$educfinh <- sav4br$EducFin
sav6r$SurveyYear <- sav6r$Surveyyear
```

```{r stdnames11, message=FALSE, warning=FALSE, include=FALSE}
sav11br$htval <- sav11br$htval2
sav11br$wtval <- sav11br$wtval2
sav11br$bmival <- sav11br$bmival2

sav11br$gor <- sav11br$GOR
sav11br$age <- sav11br$AgeR
sav11r$Age <- sav11r$AgeR
```


```{r novafile, message=FALSE, warning=FALSE, include=FALSE }
NOVA_ForDavid <- as.data.table(read_excel("data/NOVA_ForDavid.xlsx"))

NOVA_ForDavid[, Sex := factor(Sex, levels = 1:2)]
NOVA_ForDavid[, Country := factor(Country)]
NOVA_ForDavid[, SurveyYear := factor(SurveyYear)]
NOVA_ForDavid[, Age := as.numeric(Age)]
```




```{r weight, echo=FALSE}
#Doing the weighting correction, as explain in the PDF "6533_ndns_yrs9-11_weights_guide"

n1 = sum(sav4br$wti_UKY1234)  #Should be 6828

n2 = sum(sav6br$wti_Y56)         #Should be 2546

n3 = sum(sav8br$wti_Y78)         #Should be 2723

n4 = sum(sav11br$wti_Y911)       #Should be 3558

N <- sum(n1, n2, n3, n4) #Should be 15655
```


now the proportion weight for each is calculated

```{r message=FALSE, warning=FALSE, include=FALSE}
sav4br$wti_UKY1to11 <- ((sav4br$wti_UKY1234/n1) * N)  * (4/11)

sav6br$wti_UKY1to11 <- ((sav6br$wti_Y56/n2) * N) * (2/11)

sav8br$wti_UKY1to11 <- ((sav8br$wti_Y78/n3) * N) * (2/11)

sav11br$wti_UKY1to11 <- ((sav11br$wti_Y911/n4) * N) * (3/11)

```


```{r weightn, include=FALSE}
#Doing the weighting correction, as explain in the PDF "6533_ndns_yrs9-11_weights_guide"

n1 = sum(sav4br$wtn_UKY1234)  #Should be 6828

n2 = sum(sav6br$wtn_Y56)         #Should be 2546

n3 = sum(sav8br$wtn_Y78)         #Should be 2723

n4 = sum(sav11br$wtn_Y911)       #Should be 3558

N <- sum(n1, n2, n3, n4) #Should be 15655
```


now the proportion weight for each is calculated

```{r include=FALSE}
sav4br$wtn_UKY1to11 <- ((sav4br$wtn_UKY1234/n1) * N)  * (4/11)

sav6br$wtn_UKY1to11 <- ((sav6br$wtn_Y56/n2) * N) * (2/11)

sav8br$wtn_UKY1to11 <- ((sav8br$wtn_Y78/n3) * N) * (2/11)

sav11br$wtn_UKY1to11 <- ((sav11br$wtn_Y911/n4) * N) * (3/11)

```

```{r allsetup variables, message=FALSE, warning=FALSE, include=FALSE}
 #measured and recorded data yr1-4a_indiv_uk 
#subsets of the table to identify grouped information
bpset <- c("seriali","omsysval","omdiaval")
ethnset <- c("ethgrp5","ethgrp2")
saltset <- c("SaltChk","SalHowC","SltSHow" ,"vegetarn")
medsset <- c( "bpmedc2","bpmedd2","diur2","beta2","aceinh2", "calciumb2","obpdrug2", "PregNowB")
hypset <- c("hyper140_2", "hibp140_2", "hyper1_2", "highbp1_2")
incset <-c("nssec8","gor","region", "EIMD_2007_quintile","EIMD_2010_quintile","EIMD_2015_quintile","educfinh")
measset <- c("htval","wtval","bmival")
ageset <- c("agegad1", "agegad2", "agegch1","agegr1","age")
weightset <- c("wti_UKY1to11","wtn_UKY1to11","astrata1","area")

indiv_data <- c(bpset,ethnset,saltset,medsset,hypset,incset,measset,ageset,weightset)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
sav11br <- sav11br[,..indiv_data]
sav4br <- sav4br[,..indiv_data]
sav6br <- sav6br[,..indiv_data]
sav8br <- sav8br[,..indiv_data]

val_labels(sav8br) <- NULL
val_labels(sav6br) <- NULL
val_labels(sav4br) <- NULL
val_labels(sav11br) <- NULL
#sav8br$seriali <- as.double(sav8br$seriali)
#sav8br$ethgrp5 <- as.double(sav8br$ethgrp5)
```


```{r message=FALSE, warning=FALSE, include=FALSE}
#this creates the whole table
ndns_1_11 <- rbindlist(list(sav4br,sav6br,sav8br,sav11br),fill = TRUE, use.names = TRUE)

```







```{r include=FALSE}
 #define factors for 1-4 
#saltset
ndns_1_11[, SaltChk := factor(SaltChk, levels = 1:8, labels = c("Salt",
	"Salt substitute",
	"Neither",
	"Item not applicable",
	"No answer/refused",
	"Don't know",
	"Qn not applicable to survey year",
	"Schedule not applicable"))]
 ndns_1_11[, SalHowC := factor(SalHowC, levels = 1:8,labels = c("Always",
"Usually",
"Sometimes",
	",Item not applicable",
	"No answer/refused",
	" Don't know",
"Qn not applicable to survey year",
"Schedule not applicable"))]
 ndns_1_11[, SltSHow := factor(SltSHow,levels = 1:8,labels = c("Always",
                                                            "Usually",
                                                            "Sometimes",
                                                            ",Item not applicable",
                                                            "No answer/refused",
                                                            " Don't know",
                                                            "Qn not applicable to survey year",
                                                            "Schedule not applicable"))]
 
 ndns_1_11[, vegetarn := factor(vegetarn, levels = 1:3, labels = c("vegetarian","vegan","not vegetarian"))]
```
 
 
```{r include=FALSE}
#medset
 ndns_1_11[, bpmedc2 := factor(bpmedc2,levels = 0:1,	labels = c("Not taking drug"
	,"Taking drug"))]
 ndns_1_11[, bpmedd2 := factor(bpmedd2,levels = 0:1,	labels = c("Not taking drug"
	,"Taking drug"))]
  ndns_1_11[, diur2 := factor(diur2,levels = 0:1,	labels = c("Not taking drug"
	,"Taking drug"))]
ndns_1_11[, beta2 := factor(beta2,levels = 0:1,	labels = c("Not taking drug"
	,"Taking drug"))]
  ndns_1_11[, aceinh2 := factor(aceinh2,levels = 0:1,	labels = c("Not taking drug"
	,"Taking drug"))]
ndns_1_11[, calciumb2 := factor(calciumb2,levels = 0:1,	labels = c("Not taking drug"
	,"Taking drug"))]
  ndns_1_11[, obpdrug2 := factor(obpdrug2,levels = 0:1,	labels = c("Not taking drug"
	,"Taking drug"))]
ndns_1_11[, PregNowB := factor(PregNowB,levels = 1:2,	labels = c("preg or breastfeeding"
	,"not preg or Bfeed"))]
 
 


 
 
 
#incset
  
 
ndns_1_11[,gor := factor(gor, levels = 1:12, labels = c("North East","North West","Yorkshire & The Humber","East Midlands","West Midlands","East of England","London","South East","South West","Wales","Scotland","Northern Ireland"))]


ndns_1_11[,region := factor(region, levels = 1:6, labels = c("England: North","England: Central/Midlands","England: South(including London)","Scotland","Wales","Northern Ireland"))] 
  
ndns_1_11[, EIMD_2007_quintile := factor(EIMD_2007_quintile, levels = 1:5)] 
ndns_1_11[,EIMD_2010_quintile := factor(EIMD_2010_quintile, levels = 1:5)] 
ndns_1_11[,EIMD_2015_quintile := factor(EIMD_2015_quintile, levels = 1:5)] 
ndns_1_11[,educfinh := factor(educfinh, levels = 1:8)] 
ndns_1_11[,nssec8 := factor(nssec8, levels = 1:8)] 
#bpset 
 
ndns_1_11[, "omsysval" := as.numeric(omsysval)]


 #hypeset
ndns_1_11[,hyper140_2 := factor(hyper140_2,levels = 1:9, labels = c(" Normotensive untreated",
" Normotensive treated",
	"Hypertensive treated",
"Hypertensive untreated",
"No answer/refused",
	"Don't know",
"Refused, attempted but not obtained, not attempted",
	 "Qn not applicable to survey year",
"Item not applicable")) ]
 ndns_1_11[, hibp140_2 := factor(hibp140_2, levels = 1:7, labels = c("Not high BP",
"High BP",
	"No answer/refused",
	"Don't know",
	"Refused, attempted but not obtained, not attempted",
	"Qn not applicable to survey year",
	"Item not applicable")) ]
ndns_1_11[, hyper1_2 := factor(hyper1_2,levels = 1:9, labels = c(" Normotensive untreated",
                                                          " Normotensive treated",
                                                          "Hypertensive treated",
                                                          "Hypertensive untreated",
                                                          "No answer/refused",
                                                          "Don't know",
                                                          "Refused, attempted but not obtained, not attempted",
                                                          "Qn not applicable to survey year",
                                                          "Item not applicable"))]
 ndns_1_11[, highbp1_2 := factor(highbp1_2, levels = 1:7, labels = c("Not high BP",
                                                              "High BP",
                                                              "No answer/refused",
                                                              "Don't know",
                                                              "Refused, attempted but not obtained, not attempted",
                                                              "Qn not applicable to survey year",
                                                              "Item not applicable")) ]
 
 
 
 
  
#ethnset  

ndns_1_11[ , ethgrp5 := factor(ethgrp5, levels = 1:5, labels = c( 'White'
                                                             , 'Mixed ethnic group'
                                                             , 'Black or Black British'
                                                             , 'Asian or asian British'
                                                             , 'Any other group'))]
ndns_1_11[ , ethgrp2 := factor(ethgrp2, levels = 1:2, labels = c( 'White'
                                                             , 'Non-white'))]




#ageset
ndns_1_11[,agegad1 := factor(agegad1, levels = 1:4 ,labels = c("16-24","25-49","50-64","65+ years"))]
ndns_1_11[,agegad2 := factor(agegad2, levels = 1:5, labels = c("16-18","19-34","35-49","50-64","65+ years"))]
ndns_1_11[,agegch1 := factor(agegch1, levels = 1:3, labels = c("8-10","11-12","13-15"))]
ndns_1_11[,agegr1 := factor(agegr1, levels = 1:5, labels = c("1.5-3 years","4-10 years","11-18 years","19-64 years","65+ years"))]
 




 
```










### Data preparation

The data is then arranged into a format which allows processing.
This includes identifying continuous and categorical variables. 
It also includes naming the categories of the categorical variables.

 
 
 
```{r include=FALSE}
#this identifies the variables wanted from the person level data sets
perslevdat <- c("seriali","Age","SurveyYear", "Sex","Country","Sodiummg","Calciummg","VitaminDµg","TotalEMJ", "Totalsugarsg","Glucoseg","Sucroseg","Fructoseg","Lactoseg","SOFTDRINKSLOWCALORIE","SOFTDRINKSNOTLOWCALORIE", "TEACOFFEEANDWATER")



```








The data is then combined into two comprehensive tables.
```{r message=FALSE, warning=FALSE, include=FALSE}
#building the tables
sav4r <- sav4r[, ..perslevdat]
sav6r <- as.data.table(sav6r[, ..perslevdat])
sav8r <- as.data.table(sav8r[, ..perslevdat])
sav11r <- sav11r[,..perslevdat]


val_labels(sav8r) <- NULL
val_labels(sav6r) <- NULL
val_labels(sav4r) <- NULL
val_labels(sav11r) <- NULL

ndns_1_11r <- rbindlist(list(sav4r,sav6r,sav8r,sav11r),fill = TRUE, use.names = TRUE)

ndns_1_11 <- ndns_1_11[ ndns_1_11r, on = "seriali"]



```





```{r echo=FALSE}

ndns_1_11[, Sex := factor(Sex, levels = 1:2, labels = c("Male", "Female"))]
ndns_1_11[, Country := factor(Country)]



```


 
The food diary data needs more processing. In particular the NOVA categorisation is not in the data set. 
I have derived UPFNOVA from a paper which had a data table identifying the NDNS sub food groups by Rauber et al.



```{r load food diary data, message=FALSE, warning=FALSE, include=FALSE}
UPFNOVA <- data.table(read_excel("/media/david/Elements1/contents/DOHmed/MPH/MPHModules/dissertation/alternativequant/altquant/altquant/UPFNOVA.xlsx"))
#ndns_yr1_nutrientdatabank <- data.table(read_sav("UKDA-6533-spss/spss/spss25/ndns_yr1_nutrientdatabank.sav"))

#ndns_yr11_nutrient <- data.table(read_sav("UKDA-6533-spss/spss/spss25/ndns_yr11_nutrientdatabank_2021-03-19.sav"))

 ndns1_4a_foodleveldietarydata_uk_v2 <- data.table(read_sav("/media/david/Elements1/contents/DOHmed/MPH/MPHModules/dissertation/alternativequant/altquant/UKDA-6533-spss/spss/spss25/ndns_rp_yr1-4a_foodleveldietarydata_uk_v2.sav"))

ndns5_6a_foodleveldietarydata_v2 <- data.table(read_sav("/media/david/Elements1/contents/DOHmed/MPH/MPHModules/dissertation/alternativequant/altquant/UKDA-6533-spss/spss/spss25/ndns_rp_yr5-6a_foodleveldietarydata_v2.sav"))
 
ndns7_8a_foodleveldietarydata_v2 <- data.table(read_sav("/media/david/Elements1/contents/DOHmed/MPH/MPHModules/dissertation/alternativequant/altquant/UKDA-6533-spss/spss/spss25/ndns_rp_yr7-8a_foodleveldietarydata.sav"))



 ndns_rp_yr9a_foodleveldietarydata_uk_20210831 <- data.table(read_sav("/media/david/Elements1/contents/DOHmed/MPH/MPHModules/dissertation/alternativequant/altquant/UKDA-6533-spss/spss/spss25/ndns_rp_yr9a_foodleveldietarydata_uk_20210831.sav"))
 ndns_rp_yr10a_foodleveldietarydata_uk_20210831 <- data.table(read_sav("/media/david/Elements1/contents/DOHmed/MPH/MPHModules/dissertation/alternativequant/altquant/UKDA-6533-spss/spss/spss25/ndns_rp_yr10a_foodleveldietarydata_uk_20210831.sav"))
 ndns_rp_yr11a_foodleveldietarydata_uk_20210831 <- data.table(read_sav("/media/david/Elements1/contents/DOHmed/MPH/MPHModules/dissertation/alternativequant/altquant/UKDA-6533-spss/spss/spss25/ndns_rp_yr11a_foodleveldietarydata_uk_20210831.sav") )
```

####  Processing the food diaries
The Nova group is attached to the foods in the food diaries from Rauber et al @rauberUltraprocessedFoodsExcessive2019b.
The tables are reduced to the necessary variables.

```{r process food data into tables, message=FALSE, warning=FALSE, include=FALSE}
#taking data from diet diary

UPFNOVA[,`Nova group`:= factor(`Nova group`,levels = 1:4)]
UPFNOVA$SubFoodGroupCode <- UPFNOVA$`food group number`

#specifically coded food groups

#combine with key for Nova Group
#first 1-4
foodlevedat4s <- ndns1_4a_foodleveldietarydata_uk_v2[,c("seriali","SubFoodGroupCode","RecipeSubFoodGroupCode","TotalGrams","EnergykJ")]
#foodlevedat4s[ ,seriali  := factor(seriali)]
foodlevedat4s<- foodlevedat4s[UPFNOVA, on= "SubFoodGroupCode"]
#summary(foodlevedat4s)

foodlevedat4s<- foodlevedat4s[,c("seriali","TotalGrams","Nova group","EnergykJ")]

#years 5-6
foodlevedat6s <- ndns5_6a_foodleveldietarydata_v2[,c("seriali","SubFoodGroupCode","RecipeSubFoodGroupCode","TotalGrams","EnergykJ")]
foodlevedat8s <- ndns7_8a_foodleveldietarydata_v2[,c("seriali","SubFoodGroupCode","RecipeSubFoodGroupCode","TotalGrams","EnergykJ")]
foodlevedat6s<- foodlevedat6s[UPFNOVA, on= "SubFoodGroupCode"]
foodlevedat8s<- foodlevedat8s[UPFNOVA, on= "SubFoodGroupCode"]
foodlevedat6s<- foodlevedat6s[,c("seriali","TotalGrams","Nova group","EnergykJ")]
foodlevedat8s<- foodlevedat8s[,c("seriali","TotalGrams","Nova group","EnergykJ")]


#finally years 9, 10, 11
foodlevedat9s <- ndns_rp_yr9a_foodleveldietarydata_uk_20210831[,c("seriali","SubFoodGroupCode","RecipeSubFoodGroupCode","TotalGrams","EnergykJ")]
foodlevedat10s <- ndns_rp_yr10a_foodleveldietarydata_uk_20210831[,c("seriali","SubFoodGroupCode","RecipeSubFoodGroupCode","TotalGrams","EnergykJ")]
foodlevedat11s <- ndns_rp_yr11a_foodleveldietarydata_uk_20210831[,c("seriali","SubFoodGroupCode","RecipeSubFoodGroupCode","TotalGrams","EnergykJ")]

#combine with key for Nova Group

foodlevedat9s<- foodlevedat9s[UPFNOVA, on= "SubFoodGroupCode"]
foodlevedat10s<- foodlevedat10s[UPFNOVA, on= "SubFoodGroupCode"]
foodlevedat11s<- foodlevedat11s[UPFNOVA, on= "SubFoodGroupCode"]



foodlevedat9s<- foodlevedat9s[,c("seriali","TotalGrams","Nova group","EnergykJ")]
foodlevedat10s<- foodlevedat10s[,c("seriali","TotalGrams","Nova group","EnergykJ")]
foodlevedat11s<- foodlevedat11s[,c("seriali","TotalGrams","Nova group","EnergykJ")]

```

```{r message=FALSE, warning=FALSE, include=FALSE}
#heatmap(foodlevedat9s, Colv = "TotalGrams")

```


To work out the gram weight amount of food intake by each individual, first the diary entries for each individual are totalled up.
The total gram weight value of intake of each food is then worked out as a percentage of the total intake.

```{r function defn, message=FALSE, warning=FALSE, include=FALSE}
## First I write the function to process the individual entries. This totals the intake in grams and identifies the proportion by nova type.



IndividDiet <- function(DT,individ) {
  pers <- DT[seriali==individ]
pers
oneweight<-pers[, round(sum(TotalGrams),2), by=`Nova group`][order(`Nova group`)]

setnames( oneweight, 'V1','Totalg')
 oneweight[,pcnt := round((Totalg/sum(Totalg)*100),2)]

  return(na.exclude(oneweight))
}


```

All these individual calculations are then built back up into tables. 
This is done for years 9-11 and then 1-4.


```{r year 9 process, message=FALSE, warning=FALSE, include=FALSE}
### This section uses the function designed above to process the table
name <-foodlevedat9s[,.(seriali)]  
name <- as.numeric(unlist(name))
nameu <-c(unique(name))
x <- length(nameu)  
#nameu
outcome <- data.table()

for (i in 1:x){
  


output<- IndividDiet(foodlevedat9s,nameu[i])  

output$seriali <- nameu[i]

 outcome <-rbind(outcome,output) 
 
 
}

foodleveldat9sp <-dcast.data.table(outcome, seriali  ~ `Nova group` , value.var = c('Totalg',"pcnt"))
#foodleveldat9sp



```

```{r year 10 process, warning=FALSE, include=FALSE}

name <-foodlevedat10s[,.(seriali)]  
name <- as.numeric(unlist(name))
nameu <-c(unique(name))
x <- length(nameu)
#summary(nameu)
outcome <- data.table()

for (i in 1:x){
  


output<- IndividDiet(foodlevedat10s,nameu[i])  

output$seriali <- nameu[i]

 outcome <-rbind(outcome,output) 
 
 
}

foodleveldat10sp <-dcast.data.table(outcome, seriali  ~ `Nova group` , value.var = c('Totalg',"pcnt"))
#foodleveldat10sp


```


```{r year 11 process, message=FALSE, warning=FALSE, include=FALSE}

name <-foodlevedat11s[,.(seriali)]  
name <- as.numeric(unlist(name))
nameu <-c(unique(name))
x <- length(nameu)
#summary(nameu)
outcome <- data.table()

for (i in 1:x){
  


output<- IndividDiet(foodlevedat11s,nameu[i])  

output$seriali <- nameu[i]

 outcome <-rbind(outcome,output) 
 
 
}

foodleveldat11sp <-dcast.data.table(outcome, seriali  ~ `Nova group` , value.var = c('Totalg',"pcnt"))
#foodleveldat11sp

#then combining the outputs 9-11
foodleveldat910sp <- rbind(foodleveldat9sp,foodleveldat10sp)
foodleveldat911sp <- rbind(foodleveldat11sp, foodleveldat910sp)
```


```{r year 5-6 process, warning=FALSE, include=FALSE}

name <-foodlevedat6s[,.(seriali)]  
name <- as.numeric(unlist(name))
nameu <-c(unique(name))
x <- length(nameu)
#summary(nameu)
outcome <- data.table()

for (i in 1:x){
  


output<- IndividDiet(foodlevedat6s,nameu[i])  

output$seriali <- nameu[i]

 outcome <-rbind(outcome,output) 
 
 
}

foodleveldat6sp <-dcast.data.table(outcome, seriali  ~ `Nova group` , value.var = c('Totalg',"pcnt"))
#foodleveldat6sp


```


```{r year 7-8 process, warning=FALSE, include=FALSE}

name <-foodlevedat8s[,.(seriali)]  
name <- as.numeric(unlist(name))
nameu <-c(unique(name))
x <- length(nameu)
#summary(nameu)
outcome <- data.table()

for (i in 1:x){
  


output<- IndividDiet(foodlevedat8s,nameu[i])  

output$seriali <- nameu[i]

 outcome <-rbind(outcome,output) 
 
 
}

foodleveldat8sp <-dcast.data.table(outcome, seriali  ~ `Nova group` , value.var = c('Totalg',"pcnt"))
#foodleveldat8sp


```


```{r slow processing four years, echo=FALSE, warning=FALSE}

name <-foodlevedat4s[,.(seriali)]  
name <- (unlist(name))
nameu <-c(unique(name))
x <- length(nameu)
#summary(nameu)
outcome <- data.table()

for (i in 1:x){
  


output<- IndividDiet(foodlevedat4s,nameu[i])  

output$seriali <- nameu[i]

 outcome <-rbind(outcome,output) 
 
 
}

foodleveldat4sp <-dcast.data.table(outcome, seriali  ~ `Nova group` , value.var = c('Totalg',"pcnt"))
#foodleveldat4sp



```

The process can be done for food level energy intake also.
```{r energy function defn, message=FALSE, warning=FALSE, include=FALSE}
## First I write the function to process the individual entries. This totals the intake in grams and identifies the proportion by nova type.



IndividDietE <- function(DT,individ) {
  pers <- DT[seriali==individ]
pers
oneweight<-pers[, round(sum(EnergykJ),2), by=`Nova group`][order(`Nova group`)]

setnames( oneweight, 'V1','EnergykJ')
 oneweight[,Epcnt := round((EnergykJ/sum(EnergykJ)*100),2)]

  return(na.exclude(oneweight))
}


```

```{r Eyear 9 process, message=FALSE, warning=FALSE, include=FALSE}
### This section uses the function designed above to process the table
name <-foodlevedat9s[,.(seriali)]  
name <- as.numeric(unlist(name))
nameu <-c(unique(name))
x <- length(nameu)  
#nameu
outcome <- data.table()

for (i in 1:x){
  


output<- IndividDietE(foodlevedat9s,nameu[i])  

output$seriali <- nameu[i]

 outcome <-rbind(outcome,output) 
 
 
}

foodleveldat9spE <-dcast.data.table(outcome, seriali  ~ `Nova group` , value.var = c('EnergykJ',"Epcnt"))
#foodleveldat9spE



```

```{r Eyear 10 process, message=FALSE, warning=FALSE, include=FALSE}
### This section uses the function designed above to process the table
name <-foodlevedat10s[,.(seriali)]  
name <- as.numeric(unlist(name))
nameu <-c(unique(name))
x <- length(nameu)  
#nameu
outcome <- data.table()

for (i in 1:x){
  


output<- IndividDietE(foodlevedat10s,nameu[i])  

output$seriali <- nameu[i]

 outcome <-rbind(outcome,output) 
 
 
}

foodleveldat10spE <-dcast.data.table(outcome, seriali  ~ `Nova group` , value.var = c('EnergykJ',"Epcnt"))
#foodleveldat10spE



```


```{r Eyear 11 process, message=FALSE, warning=FALSE, include=FALSE}
### This section uses the function designed above to process the table
name <-foodlevedat11s[,.(seriali)]  
name <- as.numeric(unlist(name))
nameu <-c(unique(name))
x <- length(nameu)  
#nameu
outcome <- data.table()

for (i in 1:x){
  


output<- IndividDietE(foodlevedat11s,nameu[i])  

output$seriali <- nameu[i]

 outcome <-rbind(outcome,output) 
 
 
}

foodleveldat11spE <-dcast.data.table(outcome, seriali  ~ `Nova group` , value.var = c('EnergykJ',"Epcnt"))
foodleveldat11spE


#then combining the outputs 9-11
foodleveldat910spE <- rbind(foodleveldat9spE,foodleveldat10spE)
foodleveldat911spE <- rbind(foodleveldat11spE, foodleveldat910spE)
```


```{r Eslow processing four years, echo=FALSE, warning=FALSE}

name <-foodlevedat4s[,.(seriali)]  
name <- (unlist(name))
nameu <-c(unique(name))
x <- length(nameu)
#summary(nameu)
outcome <- data.table()

for (i in 1:x){
  


output<- IndividDietE(foodlevedat4s,nameu[i])  

output$seriali <- nameu[i]

 outcome <-rbind(outcome,output) 
 
 
}

foodleveldat4spE <-dcast.data.table(outcome, seriali  ~ `Nova group` , value.var = c('EnergykJ',"Epcnt"))
#foodleveldat4spE



```


```{r E8 processing four years, echo=FALSE, warning=FALSE}

name <-foodlevedat8s[,.(seriali)]  
name <- (unlist(name))
nameu <-c(unique(name))
x <- length(nameu)
#summary(nameu)
outcome <- data.table()

for (i in 1:x){
  


output<- IndividDietE(foodlevedat8s,nameu[i])  

output$seriali <- nameu[i]

 outcome <-rbind(outcome,output) 
 
 
}

foodleveldat8spE <-dcast.data.table(outcome, seriali  ~ `Nova group` , value.var = c('EnergykJ',"Epcnt"))
#foodleveldat4spE



```

```{r E6 processing four years, echo=FALSE, warning=FALSE}

name <-foodlevedat6s[,.(seriali)]  
name <- (unlist(name))
nameu <-c(unique(name))
x <- length(nameu)
#summary(nameu)
outcome <- data.table()

for (i in 1:x){
  


output<- IndividDietE(foodlevedat6s,nameu[i])  

output$seriali <- nameu[i]

 outcome <-rbind(outcome,output) 
 
 
}

foodleveldat6spE <-dcast.data.table(outcome, seriali  ~ `Nova group` , value.var = c('EnergykJ',"Epcnt"))
#foodleveldat6spE



```


After that, this information is added to the other data.
This gives us the nova group information by weight and weight percent for all participants .

```{r adding to earlier data2, echo=FALSE, message=FALSE, warning=FALSE}
# combine with data from version10a.rmd

#sav11rpb <- readRDS("sav11rp.rds")


setkey(foodleveldat911sp, seriali)
setkey(foodleveldat911spE, seriali)

foodleveldat911spE <-foodleveldat911spE[foodleveldat911sp, by= seriali]
#sav11rp <-sav11rp[foodleveldat911spE, by= seriali]
#sav11rp$ED <- sav11rp[,.("Epcnt_4"/"pcnt_4")]

#sav4rp <- readRDS("sav4rp.rds")

#setkey(sav4rp,seriali)
setkey(foodleveldat4sp,seriali)
setkey(foodleveldat4spE,seriali)
foodleveldat4spE<-foodleveldat4spE[foodleveldat4sp, by= seriali]
#sav4rp <-sav4rp[foodleveldat4spE, by= seriali]


#setkey(sav6rp,seriali)
setkey(foodleveldat6sp,seriali)
setkey(foodleveldat6spE,seriali)
foodleveldat6spE <-foodleveldat6spE[foodleveldat6sp, by= seriali]
#sav6rp <-sav6rp[foodleveldat6spE, by= seriali]



#setkey(sav8rp,seriali)
setkey(foodleveldat8sp,seriali)
setkey(foodleveldat8spE,seriali)
foodleveldat8spE <-foodleveldat8spE[foodleveldat8sp, by= seriali]
#sav8rp <-sav8rp[foodleveldat8spE, by= seriali]

ndns_1_11food <- rbindlist(list(foodleveldat8spE,foodleveldat4spE,foodleveldat6spE,foodleveldat911spE))
```



The data is now ready for analysis first by descriptive analysis.





```{r adding to earlier data, echo=FALSE, message=FALSE, warning=FALSE}
# combine with data from version10a.rmd
setkey(ndns_1_11food, seriali)
setkey(ndns_1_11, seriali)
ndns_1_11 <- ndns_1_11[ndns_1_11food, by= seriali]
```

###  Exclusions 
eg hypertensives and pregnant/breastfeeding
possible future set with only England?

I have excluded those who are taking diuretics, bblockers, ace inhibitors, calcium channel blockers and other bp drugs. There are no participants who are pregnant or breastfeeding. 
I have included normotensive untreated individuals. 
I have restricted the data set to England only.
Over 18s only

```{r echo=FALSE}
#first remove from years 1-4
#ndns_1_11 <-ndns_1_11[(hyper1_2 == " Normotensive untreated" ), ]

#there are no pregnant or breast feeding participants
#ndns_1_11n <- ndns_1_11n[(PregNowB != "preg or breastfeeding" ), ]


#medication affecting bp
#ndns_1_11 <- ndns_1_11[diur2 == "Not taking drug"]
#ndns_1_11 <-ndns_1_11[beta2 == "Not taking drug"]
#ndns_1_11 <-ndns_1_11[aceinh2 == "Not taking drug"]
#ndns_1_11 <-ndns_1_11[calciumb2 =="Not taking drug"]
#ndns_1_11 <- ndns_1_11[obpdrug2 == "Not taking drug"]

#ndns_1_11 <- ndns_1_11[Country == "England"]
#ndns_1_11 <- ndns_1_11[Age >18]

```



## Descriptive data analysis

This section will review the data which will be used for the statistical analysis.
The data is summarised, with Mean median, and range for continuous variables. 
Counts are available for categorical variables.
First for years 1-4 then for 9-11.

The key variables are omsysval which is the dependant variable, and UPF energy proportion intake and sodiummg. 
These variables are the ones which most relate to the research question. 
There are a number of related variables in the dataset. These were chosen for reliability and practicality. These variables are ones whch can also influence BP.
The omsysval is a validated measurement with significant quality assessment within the dataset. 
Raw systolic values are present in the dataset but are made up of data with issues around quality. 
In particular the systolic values are assessed for the effects of exercise, temperature and ill health. 

The sodium value is one calculated from intake based on food diaries and standard food nutrient values.
This only reflects standard foods and is the result of assumptions about the content being consistent. Serum sodium values are available for the early dataset, but not the later one. 
There are also values for 24 urinary sodium which is probably a better indicator of dietary sodium for parts of the dataset, but again these are not found in both time periods.



Summary Description of the key variables of sodium intake, Total energy intake, and BP
Show the data. This is the whole dataset without exclusions.
The means show the change between the time periods.


```{r echo=FALSE, warning=FALSE}
#data(ndns_1_11)
#dw <- svydesign(ids = ~seriali, weights = ~ wti_UKY1to11, strata=~astrata1, data = ndns_1_11)

#summary(ndns_1_11)
#sysMeandw <- svymean(~omsysval, dw)
#sysMeandw

keydata <- rbind(summary(ndns_1_11[SurveyYear <= 4,Sodiummg*wti_UKY1to11]), summary(ndns_1_11[SurveyYear >= 9,Sodiummg*wti_UKY1to11]),summary(ndns_1_11[SurveyYear <= 4,pcnt_4*wti_UKY1to11]), summary(ndns_1_11[SurveyYear >= 9,pcnt_4*wti_UKY1to11]),summary(ndns_1_11[SurveyYear <= 4,Epcnt_4*wti_UKY1to11]), summary(ndns_1_11[SurveyYear >=9,Epcnt_4*wti_UKY1to11]),summary(ndns_1_11[SurveyYear <=4,omsysval*wtn_UKY1to11]), summary(ndns_1_11[SurveyYear >=9,omsysval*wtn_UKY1to11]),summary(ndns_1_11[SurveyYear <=4,omdiaval*wtn_UKY1to11]), summary(ndns_1_11[SurveyYear >=9,omdiaval*wtn_UKY1to11]))
keydata <- as.data.table(keydata)
keydata <- signif(keydata, digits = 4)
keydata$names <- c("Sodiummg", "Sodiummg", "pcnt_4", "pcnt_4", "Epcnt_4", "Epcnt_4","omsysval","omsysval","omdiaval", "omdiaval")
 

keydata

boxplot((ndns_1_11$Epcnt_4*ndns_1_11$wti_UKY1to11)~
          ndns_1_11$SurveyYear)
boxplot((ndns_1_11$Sodiummg*ndns_1_11$wti_UKY1to11)~
         ndns_1_11$SurveyYear)
boxplot((ndns_1_11$omsysval*ndns_1_11$wti_UKY1to11)~
          ndns_1_11$SurveyYear)
```
These boxplots show how the percentage of energy derived from UPF, the sodium intake, and the Systolic bp have changeed over the years.


```{r echo=FALSE, message=FALSE, warning=FALSE}
bpNa <- data.table("2010"=c(ndns_1_11[SurveyYear <= 4,Sodiummg*wti_UKY1to11]),"2019" =c(ndns_1_11[SurveyYear >= 9,Sodiummg*wti_UKY1to11]))
boxplot(bpNa, main = "Sodiummg 2010 vs 2019", xlab = "year", ylab = "Sodium mg")
bpgram <-data.table("2010" =c(ndns_1_11[SurveyYear <= 4,pcnt_4*wti_UKY1to11]),"2019" = c(ndns_1_11[SurveyYear >= 9,pcnt_4*wti_UKY1to11]))
boxplot(bpgram, main = "Weight Percent UPF 2010 vs 2019", xlab = "year", ylab = "pcnt_4")
bpE <-data.table("2010" =c(ndns_1_11[SurveyYear <= 4,Epcnt_4*wti_UKY1to11]),"2019" = c(ndns_1_11[SurveyYear >= 9,Epcnt_4*wti_UKY1to11]))
boxplot(bpE, main = " Energy Percent UPF 2010 vs 2019", xlab = "year", ylab = "Epcnt_4")


bpOS <- data.table("2010" = c(ndns_1_11[SurveyYear <=4,omsysval*wti_UKY1to11]),"2019"=c(ndns_1_11[SurveyYear >=9,omsysval*wti_UKY1to11]))
boxplot(bpOS,main = "omsysval 2010 vs 2019",xlab = "year", ylab = "omsysval")
bpOD <-data.table("2010" = c(ndns_1_11[SurveyYear <=4,omdiaval*wti_UKY1to11]),"2019" = c(ndns_1_11[SurveyYear >=9,omdiaval*wti_UKY1to11]))
boxplot(bpOD, main = "omdiaval 2010 vs 2019", xlab = "year", ylab = "omdiaval")


```
## Statistical Comparison of key variables
## Comparison of key variables
### comparing UPF and Sodium intake calculated from diet



In order to confirm there has been a change in intake 
a t.test compares the means of the two samples.
One compares the means of sodium in years 1-4 with sodium in years 9-11.

The second compares the means of pcnt UPF intake in over the same periods.
A third compares the percentage energy provided by UPF.

```{r echo=FALSE}

ttestNa <- t.test(ndns_1_11[SurveyYear >= 9,Sodiummg*wti_UKY1to11], ndns_1_11[SurveyYear <= 4,Sodiummg*wti_UKY1to11])
ttestpcnt_4 <-t.test(ndns_1_11[SurveyYear >= 9,pcnt_4*wti_UKY1to11], ndns_1_11[SurveyYear <= 4,pcnt_4*wti_UKY1to11])
ttestEpcnt_4 <-t.test(ndns_1_11[SurveyYear >= 9,Epcnt_4*wti_UKY1to11], ndns_1_11[SurveyYear <= 4,Epcnt_4*wti_UKY1to11])


data.table("Var" = c("Epcnt_4","pcnt_4","Na"),"statistic" = signif(c(ttestEpcnt_4$statistic,ttestpcnt_4$statistic,ttestNa$statistic), digits = 4), "p.value" = signif(c(ttestEpcnt_4$p.value,ttestpcnt_4$p.value,ttestNa$p.value), digits = 4))
ttestpcnt_4
ttestEpcnt_4
ttestNa
```

It seems the mean percentage UPF intake changes less by 2 % and this reduction is statistically significant.
The sodium intake has changed by 5.5 mg and is also statistically significant with a p value less than 0.05.


### what about outcome  BP?
The next t tests compare mean systolic values in the two time periods and then the mean diastolic values.

```{r echo=FALSE}



ttestOS <- t.test(ndns_1_11[SurveyYear >=9,omsysval*wti_UKY1to11], ndns_1_11[SurveyYear <=4,omsysval*wti_UKY1to11])
ttestOD <- t.test(ndns_1_11[SurveyYear >=9,omdiaval*wti_UKY1to11], ndns_1_11[SurveyYear <=4,omdiaval*wti_UKY1to11])
data.table("Var" = c("Sys","Dia"),"statistic" = signif(c(ttestOS$statistic,ttestOD$statistic), digits= 4), "p.value" = signif(c(ttestOS$p.value,ttestOD$p.value), digits = 4))
```

There is a reduction in systolic, with a less significant reduction in diastolic

In summary there is a reduction in UPF and Na intake and a drop in both systolic and diastolic pressures. 



Has another factor affected the BP change ?




### Statistical analysis of Confounding variables

How are confounding variables distributed between the two datasets
The NDNS dataset was weighted to keep many of these the same between datasets. 


```{r echo=FALSE}
#from pers data
#continuous data
ttestage <-t.test(ndns_1_11[SurveyYear >= 9,Age*wti_UKY1to11], ndns_1_11[SurveyYear <= 4,Age*wti_UKY1to11])
ttestca <- t.test(ndns_1_11[SurveyYear >= 9,Calciummg*wti_UKY1to11], ndns_1_11[SurveyYear <= 4,Calciummg*wti_UKY1to11])
ttestts <-t.test(ndns_1_11[SurveyYear >= 9,Totalsugarsg*wti_UKY1to11], ndns_1_11[SurveyYear <= 4,Totalsugarsg*wti_UKY1to11])
ttestgl <-t.test(ndns_1_11[SurveyYear >= 9,Glucoseg*wti_UKY1to11], ndns_1_11[SurveyYear <= 4,Glucoseg*wti_UKY1to11])
ttestfr <- t.test(ndns_1_11[SurveyYear >= 9,Fructoseg*wti_UKY1to11], ndns_1_11[SurveyYear <= 4,Fructoseg*wti_UKY1to11])
ttestsu <-t.test(ndns_1_11[SurveyYear >= 9,Sucroseg*wti_UKY1to11], ndns_1_11[SurveyYear <= 4,Sucroseg*wti_UKY1to11])
ttestla <-t.test(ndns_1_11[SurveyYear >= 9,Lactoseg*wti_UKY1to11], ndns_1_11[SurveyYear <= 4,Lactoseg*wti_UKY1to11])
ttestlo <-t.test(ndns_1_11[SurveyYear >= 9,SOFTDRINKSLOWCALORIE*wti_UKY1to11], ndns_1_11[SurveyYear <= 4,SOFTDRINKSLOWCALORIE*wti_UKY1to11])
ttestnlo <-t.test(ndns_1_11[SurveyYear >= 9,SOFTDRINKSNOTLOWCALORIE*wti_UKY1to11], ndns_1_11[SurveyYear <= 4,SOFTDRINKSNOTLOWCALORIE*wti_UKY1to11])
ttesttc<- t.test(ndns_1_11[SurveyYear >= 9,TEACOFFEEANDWATER*wti_UKY1to11], ndns_1_11[SurveyYear <= 4,TEACOFFEEANDWATER*wti_UKY1to11])

confounders <- data.table("name" = c("Age","Calciummg","Totalsugarsg","Glucoseg","Fructoseg","Sucroseg", "Lactoseg","SOFTDRINKSLOWCALORIE","SOFTDRINKSNOTLOWCALORIE","TEACOFFEEANDWATER"), 
 "pvalue" = signif(c(ttestage$p.value, ttestca$p.value,ttestts$p.value,ttestgl$p.value,ttestfr$p.value,ttestsu$p.value,ttestla$p.value,ttestlo$p.value,ttestnlo$p.value,ttesttc$p.value), digits = 4), "statistic" = signif(c(ttestage$statistic, ttestca$statistic,ttestts$statistic,ttestgl$statistic,ttestfr$statistic,ttestsu$statistic,ttestla$statistic,ttestlo$statistic,ttestnlo$statistic,ttesttc$statistic), digits = 4))
confounders

```
They seem to all be significantly different between the datasets! (except calciummg, and lactose)

There is a difference of 5 years in the mean ages. The change in Age might be explained by more younger people being on anti-hypertensive meds. or hypertension being diagnosed earlier


There has been a change in the intake of soft drinks, tea coffee and water.

```{r echo=FALSE, warning=FALSE}

#categorical data
stable11 <- xtabs(~ndns_1_11[SurveyYear >= 9,Sex])
stable4 <- xtabs(~ ndns_1_11[SurveyYear <= 4,Sex])
stabler <- chisq.test(rbind(stable11 , stable4))


#ctable11 <- xtabs(~ndns_1_11[SurveyYear >= 9,Country*wti_UKY1to11])
#ctable4 <- xtabs(~ ndns_1_11[SurveyYear <= 4,Country*wti_UKY1to11])
#ctabler <- chisq.test(rbind(ctable4,ctable11))

catconfounders <- data.table("name" = c("Sex"),"pvalue" = signif(c(stabler$p.value),digits = 4))

catconfounders


plot(ndns_1_11[SurveyYear >= 9,Sex], main = "2019", caption = "Bar Plot of Sex in 2019 cohort")
plot( ndns_1_11[SurveyYear <= 4,Sex], main = "2010",caption = "Bar Plot of Sex in 2019 cohort")
#boxplot(ndns_1_11[,Sex], ndns_1_11[,SurveyYear])
#plot(sav11rp[,Country], main = "2019")
#plot(sav4rp[,Country], main = "2010")

```

Again significant differences
Are there time differences in diagnosis of hypertension/treatment between sexes 
ie are more women now on meds compared with the number of men than previously?
There appears to be more men excluded in the 1-4 population compared to females, when this is compared to the 2017-19 population. This supports the idea of greater equality in prescribing more recently.




comparing individual data sets looking for similarity in two
```{r echo=FALSE}
#ttests for continuous data
ttestht <- t.test(ndns_1_11[SurveyYear >= 9,htval*wti_UKY1to11], ndns_1_11[SurveyYear <= 4,htval*wti_UKY1to11])
ttestwt <- t.test(ndns_1_11[SurveyYear >= 9,wtval*wti_UKY1to11], ndns_1_11[SurveyYear <= 4,wtval*wti_UKY1to11])
ttestbmi <- t.test(ndns_1_11[SurveyYear >= 9,bmival*wti_UKY1to11], ndns_1_11[SurveyYear <= 4,bmival*wti_UKY1to11])

confounders2 <- data.table("name" = c("htval","wtval","bmival"),"pvalue" = signif(c(ttestht$p.value,ttestwt$p.value,ttestbmi$p.value),digits = 4),"pvalue" = signif(c(ttestht$statistic,ttestwt$statistic,ttestbmi$statistic),digits = 4))
confounders2




```
This table suggests that there is a significant difference between the height, and bmi of the groups.
The 11 population is shorter by 4 cm and 7 kilos lighter 
The mean bmi has dropped from 25.86 which is overweight. 
It is now 23.48 which is in the normal range. 
This would also highlight a preferential detection of high BP in those overweight.


```{r echo=FALSE, warning=FALSE}

#chisquared for categorical data
#saltset
vtable11 <- xtabs(~ndns_1_11[SurveyYear >= 9,vegetarn])
vtable4 <- xtabs(~ ndns_1_11[SurveyYear <= 4,vegetarn])
vtabler <- chisq.test(rbind(vtable11 , vtable4))

#cktable11 <- xtabs(~ndns_1_11[SurveyYear >= 9,SaltChk*wti_UKY1to11])
#cktable4 <- xtabs(~ ndns_1_11[SurveyYear <= 4,SaltChk*wti_UKY1to11])
#cktabler <- chisq.test(rbind(cktable11 , cktable4))

#hwtable11 <- xtabs(~ndns_1_11[SurveyYear >= 9,SaltHowC*wti_UKY1to11])
#hwtable4 <- xtabs(~ ndns_1_11[SurveyYear <= 4,SaltHowC*wti_UKY1to11])
#hwtabler <-chisq.test(rbind(hwtable11 , hwtable4))

#swtable11 <- xtabs(~ndns_1_11[SurveyYear >= 9,SltSHow*wti_UKY1to11])
#swtable4 <- xtabs(~nndns_1_11[SurveyYear <= 4,SltSHow*wti_UKY1to11])
#swtabler <- chisq.test(rbind(swtable11 , swtable4))

#catconfounders2 <- data.table("name" = c("vegetarn","SaltChk","SalHowC","SltShow"),"p.value" = signif(c(vtabler$p.value,cktabler$p.value,hwtabler$p.value,swtabler$p.value ),digits = 4))
catconfounders2 <- data.table("name" = c("vegetarn"),"p.value" = signif(c(vtabler$p.value ),digits = 4),"statistic" = signif(c(vtabler$statistic ),digits = 4))
catconfounders2

```
These values identify a significant difference in the number of vegetarians

```{r echo=FALSE, warning=FALSE}

#ethnset
e5table11 <- xtabs(~ndns_1_11[SurveyYear >= 9,ethgrp5])
e5table4 <- xtabs(~ndns_1_11[SurveyYear <=4,ethgrp5])
e5tabler <- chisq.test(rbind(e5table11 , e5table4))

e2table11 <- xtabs(~ndns_1_11[SurveyYear >= 9,ethgrp2])
e2table4 <- xtabs(~ndns_1_11[SurveyYear <=4,ethgrp5])
e2tabler <- chisq.test(rbind(e2table11 , e2table4))

#incset

#n8table11 <- xtabs(~sav11rp[,nssec8])
#n8table4 <- xtabs(~sav4rp[, nssec8])
#n8tabler<- chisq.test(rbind(n8table11 , n8table4))

#gtable11 <- xtabs(~sav11rp[,GOR])
#gtable4 <- xtabs(~sav4rp[,gor])
#gtabler <- chisq.test(rbind(gtable11 , gtable4))

#rtable11 <- xtabs(~sav11rp[,region])
#rtable4 <- xtabs(~sav4rp[, region])
#rtabler <-chisq.test(rbind(rtable11 , rtable4))


q07table11 <- xtabs(~ndns_1_11[SurveyYear >= 9,EIMD_2007_quintile])
q07table4 <- xtabs(~ndns_1_11[SurveyYear<=4,EIMD_2007_quintile])
q07tabler <-chisq.test(rbind(q07table11 , q07table4))

q10table11 <- xtabs(~ndns_1_11[SurveyYear >= 9,EIMD_2010_quintile])
q10table4 <- xtabs(~ndns_1_11[SurveyYear <=4,EIMD_2007_quintile])
q10tabler <-chisq.test(rbind(q10table11 , q10table4))

q15table11 <- xtabs(~ndns_1_11[SurveyYear >= 9,EIMD_2007_quintile])
q15table4 <- xtabs(~ndns_1_11[SurveyYear <=4,EIMD_2007_quintile])
q15tabler <-chisq.test(rbind(q15table11 , q15table4))

edutable11 <- xtabs(~ndns_1_11[SurveyYear >= 9,educfinh])
edutable4 <- xtabs(~ndns_1_11[SurveyYear <=4,educfinh])
edutabler <-chisq.test(rbind(edutable11 , edutable4))


#catconfounders3a <- data.table("name" = c("GOR","region"),"p.value" =signif(c( gtabler$p.value, rtabler$p.value ),digits = 4))

catconfounders3b <- data.table("name" = c("ethgrp5","ethgrp2"),"statistic" =signif(c(e5tabler$statistic, e2tabler$statistic),digits = 4),"p.value" =signif(c(e5tabler$p.value, e2tabler$p.value),digits = 4))

catconfounders3c <- data.table("name" = c("EIMD_2007_quintile","EIMD_2010_quintile","EIMD_2015_quintile"),"statistic" =signif(c(q07tabler$statistic, q10tabler$statistic, q15tabler$statistic),digits = 4),"p.value" =signif(c(q07tabler$p.value, q10tabler$p.value, q15tabler$p.value),digits = 4))

catconfounders3d <- data.table("name" = c("educfin"),"statistic" =signif(c(edutabler$statistic),digits = 4),"p.value" =signif(c(edutabler$p.value),digits = 4))

#catconfounders3a
catconfounders3b
catconfounders3c
catconfounders3d
```
There are differences in ethnicity as divided into 5 subgroups.
The differences in qimd, using the 2010 definitions, are not statistically significant.
There is a difference in the age of finishing education.

```{r echo=FALSE, warning=FALSE}

#hypeset

h1table11 <- xtabs(~ndns_1_11[SurveyYear >= 9,hyper1_2])
h1table4 <- xtabs(~ndns_1_11[SurveyYear <=4,hyper1_2])
h1tabler <- chisq.test(rbind(h1table11 , h1table4))

h14table11 <- xtabs(~ndns_1_11[SurveyYear >= 9,hyper140_2])
h14table4 <- xtabs(~ndns_1_11[SurveyYear <=4,hyper140_2])
h14tabler <- chisq.test(rbind(h14table11 , h14table4))

#hi1table11 <- xtabs(~sav11rp[,highbp1_2])
#hi1table4 <- xtabs(~sav4rp[, highbp1 ])
#hi1tabler <- chisq.test(rbind(hi1table11 , hi1table4))

hi14table11 <- xtabs(~ndns_1_11[SurveyYear >= 9,hibp140_2])
hi14table4 <- xtabs(~ndns_1_11[SurveyYear <=4,hibp140_2])
hi14tabler <- chisq.test(rbind(hi14table11 , hi14table4))

#ageset

ad1table11 <- xtabs(~ndns_1_11[SurveyYear >= 9,agegad1])
ad1table4 <- xtabs(~ndns_1_11[SurveyYear <=4,agegad1])
ad1tabler <- chisq.test(rbind(ad1table11 , ad1table4))

ad2table11 <- xtabs(~ndns_1_11[SurveyYear >= 9,agegad2])
ad2table4 <- xtabs(~ndns_1_11[SurveyYear <=4,agegad2])
ad2tabler <- chisq.test(rbind(ad2table11 , ad2table4))

#ch1table11 <- xtabs(~sav11rp[,agegch1])
#ch1table4 <- xtabs(~sav4rp[, agegch1 ])
#ch1tabler <-chisq.test(rbind(ch1table11 , ch1table4))

#ag1table11 <- xtabs(~sav11rp[, agegr1])
#ag1table4 <- xtabs(~sav4rp[, agegr1])
#ag1tabler <- chisq.test(rbind(ag1table11 , ag1table4))

catconfounders4a <- data.table("name" = c("agegad1","agegad2"),"p.value" = signif( c( ad1tabler$p.value , ad2tabler$p.value), digits = 4))

catconfounders4b <- data.table("name" = c("hyper1","hyper140","highbp1","hibp140"),"p.value" = signif( c(h1tabler$p.value, h14tabler$p.value, 0, hi14tabler$p.value), digits = 4))


catconfounders4a
#catconfounders4b
```
The age groups show some discrepancy with the p value significant only in the child age groups.

```{r echo=FALSE, warning=FALSE}

#medset

mctable11 <- xtabs(~ndns_1_11[SurveyYear >= 9,bpmedc2])
mctable4 <- xtabs(~ndns_1_11[SurveyYear <=4,bpmedc2 ])
mctabler <- chisq.test(rbind(mctable11 , mctable4))

mdtable11 <- xtabs(~ndns_1_11[SurveyYear >= 9, bpmedd2])
mdtable4 <- xtabs(~ndns_1_11[SurveyYear <=4, bpmedd2])
mdtabler <- chisq.test(rbind(mdtable11 , mdtable4))

ditable11 <- xtabs(~ndns_1_11[SurveyYear >= 9,diur2])
ditable4 <- xtabs(~ndns_1_11[SurveyYear <=4, diur2])
ditabler <- chisq.test(rbind(ditable11 , ditable4))

betable11 <- xtabs(~ndns_1_11[SurveyYear >= 9,beta2])
betable4 <- xtabs(~ndns_1_11[SurveyYear <=4, beta2])
betabler <- chisq.test(rbind(betable11 , betable4))

cbtable11 <- xtabs(~ndns_1_11[SurveyYear >= 9,calciumb2])
cbtable4 <- xtabs(~ndns_1_11[SurveyYear <=4, calciumb2])
cbtabler <-chisq.test(rbind(cbtable11 , cbtable4))

acetable11 <- xtabs(~ndns_1_11[SurveyYear >= 9, aceinh2])
acetable4 <- xtabs(~ndns_1_11[SurveyYear <=4, aceinh2])
acetabler <- chisq.test(rbind(acetable11 , acetable4))

othtable11 <- xtabs(~ndns_1_11[SurveyYear >= 9,obpdrug2])
othtable4 <- xtabs(~ndns_1_11[SurveyYear <=4, obpdrug2])
othtabler <- chisq.test(rbind(othtable11 , othtable4))

prtable11 <- xtabs(~ndns_1_11[SurveyYear >= 9,PregNowB])
prtable4 <- xtabs(~ndns_1_11[SurveyYear <=4, PregNowB])
prtabler <- chisq.test(rbind(prtable11 , prtable4))

catconfounders5 <- data.table("name" = c("bpmedc","bpmedd","diur","beta","calciumb","aceinh","obpdrug","PregNowB"), "p.value" = signif(c(mctabler$p.value, mdtabler$p.value, ditabler$p.value, betabler$p.value, cbtabler$p.value, acetabler$p.value, othtabler$p.value, prtabler$p.value ),digits = 4))

catconfounders5

```







##  Regression Analysis
###  linear regression



Simple linear regression equations look for the relationship between the dependant variable, and the independent variable.
For these I am looking at the whole dataset
Firstly I will plot  omsysval and sodiummg, then omsysval and Epcnt, then omsysval and pcnt.


```{r}
plot(ndns_1_11[,omsysval*wti_UKY1to11], ndns_1_11[,Sodiummg*wti_UKY1to11])
plot(ndns_1_11[,omsysval*wti_UKY1to11], ndns_1_11[,Epcnt_4*wti_UKY1to11])
plot(ndns_1_11[,omsysval*wti_UKY1to11], ndns_1_11[,pcnt_4*wti_UKY1to11])

```

The regression models for teh individual variables against omsysval
pcnt_4


```{r echo=FALSE}
#linear regression models
#UPF gram % only

lm1g <- lm((omsysval) ~ (pcnt_4), weight = wti_UKY1to11,ndns_1_11)



lm1g
anova(lm1g)
AIC(lm1g)


sensemakr(lm1g, treatment = "pcnt_4")

```
Epcnt_4
```{r echo=FALSE}
#linear regression models
#UPF Energy % only
lm1E <- lm(omsysval ~ Epcnt_4,weight = wti_UKY1to11, ndns_1_11)



lm1E


anova(lm1E)
AIC(lm1E)


sensemakr(lm1E, treatment = "Epcnt_4")

```
sodiummg

```{r echo=FALSE}
#linear regression models
#sodium only
lm1na <- lm(omsysval ~ Sodiummg,weight = wti_UKY1to11, ndns_1_11)





(lm1na)

anova(lm1na)
AIC(lm1na)


sensemakr(lm1na, treatment = "Sodiummg")


```


There are relationships between Na and g pcnt as well as E pcnt and omsysval .

### multi variable regression 

This uses a model of variables. It can highlight the contributions of each.

This first model looks at the relationships between BP and Age and Sex 

```{r echo=FALSE}
#linear regression models
#sodium only
lm1AS <- lm(omsysval ~ Age + Sex,weight = wti_UKY1to11, ndns_1_11)





(lm1AS)

anova(lm1AS)
AIC(lm1AS)

sensemakr(lm1AS, treatment = "Age")

#sensemakr(lm1AS, treatment = "Sex")

```
The next model looks at a large number of variables


```{r echo=FALSE}
lmM <- lm(omsysval ~ Age +Sex +Sodiummg + sqrt(pcnt_4)+ ethgrp2 + VitaminDµg + educfinh+ EIMD_2010_quintile ,weight = wti_UKY1to11, ndns_1_11,na.action = na.exclude)

lmM


anova(lmM)
AIC(lmM)


#sensemakr(lmM, treatment = "Age")


```

These models can be compared with others with different variables to understand how they help predict values more or less effectively.


```{r echo=FALSE}
lmM2 <- lm(omsysval ~ Age +Sex +Sodiummg + Epcnt_4+ ethgrp2 + VitaminDµg +educfinh+ EIMD_2010_quintile ,weight = wti_UKY1to11, ndns_1_11,na.action = na.exclude)



lmM2

anova(lmM2)
AIC(lmM2)

```

this model has sodium and gram percent



```{r echo=FALSE}
lmMna <- lm(omsysval ~ Age +Sex +Sodiummg + sqrt(pcnt_4) ,weight = wti_UKY1to11, ndns_1_11,na.action =na.exclude)



lmMna


anova(lmMna)
AIC(lmMna)

```
This model has Sodium and energy pcnt
```{r echo=FALSE}
lmMnaE <- lm(omsysval ~ Age +Sex +Sodiummg + Epcnt_4 ,weight = wti_UKY1to11, ndns_1_11,na.action =na.exclude)

lmMnaE


anova(lmMnaE)
AIC(lmMnaE)

```
this model has Age sex and g pcnt only

```{r echo=FALSE}
lmMg <- lm(omsysval ~ Age +Sex + sqrt(pcnt_4) ,weight = wti_UKY1to11, ndns_1_11)


lmMg

anova(lmMg)
AIC(lmMg)

```

```{r echo=FALSE}
lm4b <- lm(omsysval ~ Age +Sex + Epcnt_4 ,weight = wti_UKY1to11, ndns_1_11)

lm4b

anova(lm4b)
AIC(lm4b)


sensemakr(lm4b, treatment = "Epcnt_4")



```
What has removing the sodium done to anova and AIC?

This last model is just sodium with Age and sex

```{r echo=FALSE}
lm4c <- lm(omsysval ~ Age +Sex +Sodiummg  ,weight = wti_UKY1to11, ndns_1_11)

lm4c


anova(lm4c)
AIC(lm4c)


sensemakr(lm4c, treatment = "Sodiummg")



```



## This final set analyses the whole dataset together across the key variables
Then tests them across two sets of UPF data one calculated using Rauber, the other from ZC.
First for gram percent UPF 4
```{r message=FALSE, warning=FALSE, include=FALSE}


setkey(NOVA_ForDavid, "seriali")
setkey(ndns_1_11, "seriali")
alldata <- ndns_1_11[NOVA_ForDavid, on = "seriali"]

lmallg <- lm(omsysval~ Age+ Sex + Sodiummg +pcnt_4,weight = wti_UKY1to11, alldata)
lmallg
anova(lmallg)

lmallgz <- lm(omsysval~ Age+ Sex + Sodiummg +NOVA_Gpct_opti_4,weight = wti_UKY1to11, alldata)
lmallgz
anova(lmallgz)
```


the second set compares Energy percent upf between the two datasets
```{r message=FALSE, warning=FALSE, include=FALSE}
lmallE <- lm(omsysval~ Age+ Sex + Sodiummg +Epcnt_4,weight = wti_UKY1to11, alldata)
lmallE
anova(lmallE)
AIC(lmallE)



lmallEz <- lm(omsysval~ Age+ Sex + Sodiummg +NOVA_Epct_opti_4,weight = wti_UKY1to11, alldata)
lmallEz
anova(lmallEz)
AIC(lmallEz)



SmallE <- sensemakr(lmallE, treatment = "Epcnt_4")
Smallg <- sensemakr(lmallg, treatment = "pcnt_4")
summary(SmallE)
summary(Smallg)

```






## Summary

The data from 2008-11 and 2017-19 NDNS datasets have been downloaded and adapted into a form to approach the research question.

The key variables of BP, 'omsysval' and 'omdiaval' are taken directly from the data.
The diary entries are identified by NOVA type. 
The total weight of each nova type is calculated for each individual. 
The percentage of the total weight food intake per person is then calculated. 
This gives the derived value 'pcnt_4', which is the percentage of intake which is NOVA 4 or UPF.
The total energy in kJ of each nova type is calculated for each individual. 
The percentage of the total energy food intake per person is then calculated. 
This gives the derived value 'Epcnt_4', which is the percentage of intake which is NOVA 4 or UPF.

There is a table with summary values for theses variables across the dataset.

Statistical analysis of the key variables shows the change in all the variables between the two time periods. 

Confounding variables are analysed and show if there has been a significant change in the balance of the populations. 
#Removing those with antihypertensive medications has removed more men in the earlier cohort compared to women. 

Regression shows a degree of association between the BP and UPF intake by weight and by energy.
It also shows the same for sodium intake.

Using Anova analysis of different multi variable regression models 
 the key variables are significant for sodium in several models, and sometimes for energy percentage. 
Sodium intake shows the strongest association in the latter 9-11 cohort.






## Conclusion

The percentage by weight of NOVA group 4 foods has decreased from 2008 to 2019.
The percentage by energy of NOVA group 4 foods has decreased from 2008 to 2019.
The mean sodium intake in mg has reduced between the two time periods. 
The systolic and diastolic BP have reduced between the two time periods.

In each period there is a correlation between systolic BP and sodium intake. 
In each period there is a correlation between systolic BP and UPF intake. 

The regression models identify that age and sex are statistically significant contributors to the BP.
Only those models from the later time period show sodium as being statistically significant in importance.
Combining the data shows the energy percentage of UPF as being a statistically significant contributor.

